{% extends "base.html" %}

{% block title %}Wunschkalender - {{ periode.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>üìÖ {{ periode.name }}</h2>
            <p class="text-muted mb-0">
                {{ monat_name }} {{ periode.fuer_monat.year }}
                <span class="badge bg-success ms-2">{{ periode.get_status_display }}</span>
            </p>
        </div>
        <a href="{% url 'schichtplan:wunschperioden_liste' %}" class="btn btn-secondary">
            ‚Üê Zur√ºck
        </a>
    </div>

    <!-- Legende -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="row small">
                <div class="col-auto"><span class="badge bg-danger">U</span> Urlaub</div>
                <div class="col-auto"><span class="badge bg-primary">2</span> Kein Tag, Nacht OK</div>
                <div class="col-auto"><span class="badge bg-warning text-dark">3</span> Keine Nacht, Tag OK</div>
                <div class="col-auto"><span class="badge bg-success">T</span> Tag bevorzugt</div>
                <div class="col-auto"><span class="badge" style="background-color: #6f42c1; color: white;">N</span> Nacht bevorzugt</div>
                <div class="col-auto"><span class="badge bg-dark">X</span> Gar nichts</div>
                <div class="col-auto"><span class="badge" style="background-color: #fd7e14; color: white;">+</span> Zusatzarbeit</div>
            </div>
        </div>
    </div>

    <!-- Kalender -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 100px;">Datum</th>
                            {% for ma in alle_mitarbeiter %}
                            <th class="text-center" style="min-width: 60px;">
                                {{ ma.schichtplan_kennung }}
                                {% if ma.pk == mitarbeiter.pk %}
                                <br><span class="badge bg-success" style="font-size: 0.7rem;">Ich</span>
                                {% endif %}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for tag in kalender_daten %}
                        <tr {% if tag.ist_wochenende %}class="table-secondary"{% endif %}>
                            <td class="fw-bold">
                                {{ tag.datum|date:"d.m." }}
                                <br>
                                <small class="text-muted">{{ tag.wochentag|slice:":2" }}</small>
                            </td>
                            
                            {% for ma in alle_mitarbeiter %}
                            <td class="text-center p-2" 
                                style="{% if ma.pk == mitarbeiter.pk %}background-color: #fff3cd; border-left: 3px solid #ffc107;{% endif %}">
                                
                                {# Zeige alle W√ºnsche - durchsuche Liste #}
                                {% for wunsch in tag.wuensche %}
                                    {% if wunsch.mitarbeiter.pk == ma.pk %}
                                        {# TREFFER! Zeige Badge mit richtiger Farbe #}
                                        {% if wunsch.wunsch == 'urlaub' %}
                                            <span class="badge bg-danger" title="{{ wunsch.get_wunsch_display }}{% if wunsch.begruendung %} - {{ wunsch.begruendung }}{% endif %}">U</span>
                                        {% elif wunsch.wunsch == 'kein_tag_aber_nacht' %}
                                            <span class="badge bg-primary" title="{{ wunsch.get_wunsch_display }}{% if wunsch.begruendung %} - {{ wunsch.begruendung }}{% endif %}">2</span>
                                        {% elif wunsch.wunsch == 'keine_nacht_aber_tag' %}
                                            <span class="badge bg-warning text-dark" title="{{ wunsch.get_wunsch_display }}{% if wunsch.begruendung %} - {{ wunsch.begruendung }}{% endif %}">3</span>
                                        {% elif wunsch.wunsch == 'tag_bevorzugt' %}
                                            <span class="badge bg-success" title="{{ wunsch.get_wunsch_display }}{% if wunsch.begruendung %} - {{ wunsch.begruendung }}{% endif %}">T</span>
                                        {% elif wunsch.wunsch == 'nacht_bevorzugt' %}
                                            <span class="badge" style="background-color: #6f42c1; color: white;" title="{{ wunsch.get_wunsch_display }}{% if wunsch.begruendung %} - {{ wunsch.begruendung }}{% endif %}">N</span>
                                        {% elif wunsch.wunsch == 'gar_nichts' %}
                                            <span class="badge bg-dark" title="{{ wunsch.get_wunsch_display }}{% if wunsch.begruendung %} - {{ wunsch.begruendung }}{% endif %}">X</span>
                                        {% elif wunsch.wunsch == 'zusatzarbeit' %}
                                            <span class="badge" style="background-color: #fd7e14; color: white;" title="{{ wunsch.get_wunsch_display }}{% if wunsch.begruendung %} - {{ wunsch.begruendung }}{% endif %}">+</span>
                                        {% else %}
                                            <span class="badge bg-secondary" title="{{ wunsch.get_wunsch_display }}">?</span>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                
                                {# Wenn eigener MA und offen: + Button #}
                                {% if ma.pk == mitarbeiter.pk and periode.ist_offen %}
                                    <a href="{% url 'schichtplan:wunsch_eingeben' periode.pk %}?datum={{ tag.datum }}" 
                                    class="btn btn-sm btn-outline-primary" 
                                    style="font-size: 0.7rem; padding: 0.1rem 0.3rem;">
                                        +
                                    </a>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Info -->
    <div class="alert alert-info mt-3">
        <strong>üí° Transparenz:</strong> Alle MA1-MA15 sehen die W√ºnsche der anderen.
        <br>
        <small>Klicken Sie auf das "+" um einen Wunsch einzutragen oder zu bearbeiten.</small>
    </div>
</div>

<style>
.table-secondary {
    background-color: rgba(108, 117, 125, 0.1) !important;
}

.badge {
    cursor: help;
    min-width: 25px;
    display: inline-block;
}

td[style*="background-color: #fff3cd"] {
    font-weight: 500;
}
</style>
{% endblock %}
